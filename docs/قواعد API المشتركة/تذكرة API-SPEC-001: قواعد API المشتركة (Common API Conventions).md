# تذكرة API-SPEC-001: قواعد API المشتركة (Common API Conventions)

هذا المستند يحدد القواعد والأنماط المشتركة التي يجب اتباعها في جميع مسارات API لتطبيق Delivery Ways، وذلك لضمان الاتساق وسهولة الاستخدام من قبل فرق الباكند والموبايل.

---

## 1. مسارات API الأساسية وإصدارات (Versioning)

| القاعدة | التفاصيل |
| :--- | :--- |
| **Base URL** | `https://api.deliveryways.com` |
| **مسار الإصدار** | جميع المسارات يجب أن تبدأ بـ `/v1/`. مثال: `POST https://api.deliveryways.com/v1/rides` |
| **سياسة الإصدار** | سيتم استخدام نظام الإصدار الرئيسي (Major Versioning). أي تغييرات كاسرة (Breaking Changes) في العقود الحالية (مثل حذف حقل مطلوب، تغيير نوع بيانات، أو تغيير مسار) ستتطلب زيادة رقم الإصدار إلى `/v2/`. التغييرات غير الكاسرة (Non-Breaking Changes) مثل إضافة حقول اختيارية جديدة ستظل ضمن `/v1/`. |

---

## 2. المصادقة (Authentication)

تعتمد المصادقة على بروتوكول **Bearer Token** عبر هيدر `Authorization`.

### 2.1. هيدرات الطلب (Request Headers)

يجب أن يحتوي كل طلب مصادق عليه على الهيدرات التالية:

| الهيدر | القيمة | الوصف |
| :--- | :--- | :--- |
| `Authorization` | `Bearer <token>` | رمز الوصول (Access Token) الذي تم الحصول عليه بعد تسجيل الدخول. |
| `X-Client-Version` | `dw-app/1.0.0` | إصدار تطبيق العميل (مثال: `dw-app/1.0.0`). يُستخدم لتتبع التوافق. |
| `X-Platform` | `android` أو `ios` | نظام تشغيل العميل. يُستخدم لأغراض التحليل والتتبع. |

### 2.2. التعامل مع الرموز (Tokens)

يجب أن يتبع البروتوكول التالي للتعامل مع رموز الوصول:

*   **انتهاء الصلاحية (Expiration):** عند انتهاء صلاحية رمز الوصول، يجب على API أن يعيد خطأ `401 Unauthorized`.
*   **تحديث الرمز (Refresh):** يجب أن يوفر API مسارًا منفصلاً لتحديث رمز الوصول باستخدام رمز التحديث (Refresh Token) دون الحاجة لإعادة تسجيل الدخول الكامل. (هذا التفصيل يخص مسار `accounts_shims` وسيتم توثيقه في مكانه، لكن يجب أن يكون متوقعًا على مستوى البروتوكول).

---

## 3. تنسيق الأخطاء الموحد (Standardized Error Format)

في حال حدوث أي خطأ لا يعيد رمز حالة HTTP قياسي (مثل `404 Not Found` لكيان غير موجود)، يجب أن يكون جسم الاستجابة (Response Body) موحدًا بالتنسيق التالي:

```json
{
  "error": {
    "code": "invalid_request",
    "message": "Pickup location is required",
    "details": {
      "field": "pickup"
    }
  }
}
```

### 3.1. أكواد الأخطاء القياسية (Standard Error Codes)

| رمز الخطأ (`code`) | رمز حالة HTTP | الوصف |
| :--- | :--- | :--- |
| `invalid_request` | 400 Bad Request | فشل في التحقق من صحة البيانات المدخلة (Validation Error). |
| `unauthorized` | 401 Unauthorized | فشل في المصادقة (مثل رمز وصول غير صالح أو منتهي الصلاحية). |
| `forbidden` | 403 Forbidden | تم المصادقة بنجاح، لكن المستخدم لا يملك الصلاحية للوصول للمورد. |
| `not_found` | 404 Not Found | المورد المطلوب غير موجود. |
| `conflict` | 409 Conflict | تعارض في حالة المورد (مثل محاولة إلغاء رحلة مكتملة). |
| `rate_limited` | 429 Too Many Requests | تجاوز الحد المسموح به من الطلبات. |
| `internal_error` | 500 Internal Server Error | خطأ غير متوقع في الخادم. |

---

## 4. التصفح والترقيم (Pagination & Listing)

سيتم استخدام نمط **Cursor-based Pagination** لجميع مسارات القوائم (Listing Endpoints) لضمان الأداء الأمثل والاستقرار.

### 4.1. تنسيق الاستجابة (Response Format)

يجب أن تكون استجابة القائمة بالتنسيق التالي:

```json
{
  "data": [
    // قائمة الكيانات المطلوبة
  ],
  "next_cursor": "abc123" // مؤشر (Cursor) للصفحة التالية، يكون null إذا كانت هذه هي الصفحة الأخيرة
}
```

### 4.2. معلمات الاستعلام (Query Parameters)

يتم استخدام المؤشر في طلب الصفحة التالية عبر معلمات الاستعلام:

| المعلمة | النوع | الوصف |
| :--- | :--- | :--- |
| `cursor` | string | المؤشر الذي تم الحصول عليه من حقل `next_cursor` في الاستجابة السابقة. |
| `limit` | integer | الحد الأقصى لعدد العناصر المراد إرجاعها في الصفحة الواحدة (القيمة الافتراضية 20). |

**مثال على طلب قائمة الطلبات:**

`GET /v1/orders?cursor=abc123&limit=20`

---

## 5. الطوابع الزمنية والمعرفات (Timestamps & IDs)

### 5.1. الطوابع الزمنية (Timestamps)

*   **الصيغة:** يجب أن تكون جميع الطوابع الزمنية بصيغة **ISO8601** وممثلة بتوقيت **UTC** (مع لاحقة `Z`).
*   **مثال:** `2025-01-01T10:00:00Z`

### 5.2. المعرفات (IDs)

*   **الصيغة:** يجب أن تكون جميع المعرفات نصية (string) ومسبوقة بنوع الكيان لسهولة القراءة والتمييز.
*   **أمثلة:** `trip_123`، `order_456`، `user_789`، `driver_101`
